name: Preview Deploy

on:
  workflow_call:
    inputs:
      app-name:
        type: string
        required: true
      has-node-build:
        type: boolean
        default: true
      extra-env:
        type: string
        default: ''
    secrets:
      FORGE_TOKEN:
        required: true
      FORGE_SERVER:
        required: true
      FORGE_DB_PASSWORD:
        required: true
      FORGE_STRIPE_KEY:
        required: false
      FORGE_STRIPE_SECRET:
        required: false
      FORGE_STRIPE_WEBHOOK_SECRET:
        required: false

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      deploy: ${{ steps.check-title.outputs.deploy }}
    steps:
      - name: Check PR title and draft status
        id: check-title
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_DRAFT: ${{ github.event.pull_request.draft }}
        run: |
          if [[ "$PR_TITLE" == *"[preview]"* && "$PR_DRAFT" != "true" ]]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi

  provision:
    needs: check
    if: needs.check.outputs.deploy == 'true'
    runs-on: ubuntu-latest
    container: kirschbaumdevelopment/laravel-test-runner:8.4
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Harbor
        run: |
          curl -sL https://github.com/mehrancodes/laravel-harbor/releases/latest/download/harbor -o /usr/local/bin/harbor
          chmod +x /usr/local/bin/harbor

      - name: Provision with Harbor
        env:
          FORGE_TOKEN: ${{ secrets.FORGE_TOKEN }}
          FORGE_SERVER: ${{ secrets.FORGE_SERVER }}
          FORGE_GIT_REPOSITORY: ${{ github.repository }}
          FORGE_GIT_BRANCH: ${{ github.head_ref }}
          FORGE_DOMAIN: preview.intentional.systems
        run: |
          if [[ "${{ inputs.has-node-build }}" == "true" ]]; then
            echo "npm ci && npm run build" > deploy_script.sh
          else
            touch deploy_script.sh
          fi
          harbor provision

      - name: Configure Environment
        env:
          FORGE_TOKEN: ${{ secrets.FORGE_TOKEN }}
          FORGE_SERVER: ${{ secrets.FORGE_SERVER }}
          FORGE_DB_PASSWORD: ${{ secrets.FORGE_DB_PASSWORD }}
          FORGE_STRIPE_KEY: ${{ secrets.FORGE_STRIPE_KEY }}
          FORGE_STRIPE_SECRET: ${{ secrets.FORGE_STRIPE_SECRET }}
          FORGE_STRIPE_WEBHOOK_SECRET: ${{ secrets.FORGE_STRIPE_WEBHOOK_SECRET }}
        run: |
          # Derive site name (keep hyphens)
          BRANCH="${{ github.head_ref }}"
          SITE_NAME=$(echo "$BRANCH" | tr -cd '[:alnum:]-')
          echo "Site name: $SITE_NAME"
          
          # Look up site ID via Forge API
          SITE_ID=$(curl -s -H "Authorization: Bearer $FORGE_TOKEN" \
            "https://forge.laravel.com/api/v1/servers/$FORGE_SERVER/sites" | \
            jq -r ".sites[] | select(.name == \"$SITE_NAME\") | .id")
          echo "Site ID: $SITE_ID"
          
          # Grant forge DB user access to all databases
          curl -X POST -H "Authorization: Bearer $FORGE_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"name": "forge", "password": "'$FORGE_DB_PASSWORD'", "databases": ["*"]}' \
            "https://forge.laravel.com/api/v1/servers/$FORGE_SERVER/mysql-users"
          
          # Write .env file
          cat > .env << EOF
          APP_NAME="${{ inputs.app-name }}"
          APP_ENV=staging
          APP_KEY=
          APP_DEBUG=true
          APP_TIMEZONE=UTC
          APP_URL=https://$SITE_NAME.preview.intentional.systems
          
          APP_LOCALE=en
          APP_FALLBACK_LOCALE=en
          APP_FAKER_LOCALE=en_US
          
          APP_MAINTENANCE_DRIVER=file
          
          BCRYPT_ROUNDS=12
          
          LOG_CHANNEL=stack
          LOG_STACK=single
          LOG_DEPRECATIONS_CHANNEL=null
          LOG_LEVEL=debug
          
          DB_CONNECTION=mysql
          DB_HOST=127.0.0.1
          DB_PORT=3306
          DB_DATABASE=forge
          DB_USERNAME=forge
          DB_PASSWORD=$FORGE_DB_PASSWORD
          
          SESSION_DRIVER=database
          SESSION_LIFETIME=120
          SESSION_ENCRYPT=false
          SESSION_PATH=/
          SESSION_DOMAIN=null
          
          BROADCAST_CONNECTION=log
          FILESYSTEM_DISK=local
          QUEUE_CONNECTION=database
          
          CACHE_STORE=database
          CACHE_PREFIX=
          
          MEMCACHED_HOST=127.0.0.1
          
          REDIS_CLIENT=phpredis
          REDIS_HOST=127.0.0.1
          REDIS_PASSWORD=null
          REDIS_PORT=6379
          
          MAIL_MAILER=log
          MAIL_HOST=127.0.0.1
          MAIL_PORT=2525
          MAIL_USERNAME=null
          MAIL_PASSWORD=null
          MAIL_ENCRYPTION=null
          MAIL_FROM_ADDRESS="hello@example.com"
          MAIL_FROM_NAME="\${{ inputs.app-name }}"
          
          AWS_ACCESS_KEY_ID=
          AWS_SECRET_ACCESS_KEY=
          AWS_DEFAULT_REGION=us-east-1
          AWS_BUCKET=
          AWS_USE_PATH_STYLE_ENDPOINT=false
          
          VITE_APP_NAME="\${{ inputs.app-name }}"
          EOF
          
          # Append extra-env input if provided
          EXTRA_ENV="${{ inputs.extra-env }}"
          if [ -n "$EXTRA_ENV" ]; then
            echo "$EXTRA_ENV" >> .env
          fi
          
          # Append Stripe secrets if provided
          if [ -n "${FORGE_STRIPE_KEY:-}" ]; then
            cat >> .env << EOF
          STRIPE_KEY=${FORGE_STRIPE_KEY}
          STRIPE_SECRET=${FORGE_STRIPE_SECRET}
          STRIPE_WEBHOOK_SECRET=${FORGE_STRIPE_WEBHOOK_SECRET}
          EOF
          fi
          
          # Run Laravel commands
          php artisan key:generate
          php artisan storage:link
          php artisan migrate:fresh --seed --force
          php artisan config:cache
          
          # Sleep for commands to complete
          sleep 30

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ github.head_ref }}';
            const siteName = branch.replace(/[^a-zA-Z0-9-]/g, '');
            const previewUrl = `https://${siteName}.preview.intentional.systems`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ **Preview deployed!**\n\nðŸ“± **Preview URL:** ${previewUrl}\n\n_This preview will be automatically torn down when the PR is closed._`
            });