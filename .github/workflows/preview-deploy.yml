name: Preview Deploy

on:
  workflow_call:
    inputs:
      app-name:
        type: string
        required: true
      has-node-build:
        type: boolean
        default: true
      extra-env:
        type: string
        default: ''
    secrets:
      FORGE_TOKEN:
        required: true
      FORGE_SERVER:
        required: true
      FORGE_DB_PASSWORD:
        required: true
      FORGE_STRIPE_KEY:
        required: false
      FORGE_STRIPE_SECRET:
        required: false
      FORGE_STRIPE_WEBHOOK_SECRET:
        required: false

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      deploy: ${{ steps.check-title.outputs.deploy }}
    steps:
      - name: Check PR title and draft status
        id: check-title
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_DRAFT: ${{ github.event.pull_request.draft }}
        run: |
          if [[ "$PR_TITLE" == *"[preview]"* && "$PR_DRAFT" != "true" ]]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi

  provision:
    needs: check
    if: needs.check.outputs.deploy == 'true'
    runs-on: ubuntu-latest
    container: kirschbaumdevelopment/laravel-test-runner:8.4
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Harbor
        run: |
          curl -sL https://github.com/mehrancodes/laravel-harbor/releases/latest/download/harbor -o /usr/local/bin/harbor
          chmod +x /usr/local/bin/harbor

      - name: Provision with Harbor
        env:
          FORGE_TOKEN: ${{ secrets.FORGE_TOKEN }}
          FORGE_SERVER: ${{ secrets.FORGE_SERVER }}
          FORGE_GIT_REPOSITORY: ${{ github.repository }}
          FORGE_GIT_BRANCH: ${{ github.head_ref }}
          FORGE_DOMAIN: preview.intentional.systems
          FORGE_DB_PASSWORD: ${{ secrets.FORGE_DB_PASSWORD }}
        run: |
          harbor provision

      - name: Debug Forge token access
        env:
          FORGE_TOKEN: ${{ secrets.FORGE_TOKEN }}
          FORGE_SERVER: ${{ secrets.FORGE_SERVER }}
        run: |
          BRANCH="${{ github.head_ref }}"
          SITE_NAME=$(echo "$BRANCH" | tr -cd '[:alnum:]-')
          SITE_DOMAIN="${SITE_NAME}.preview.intentional.systems"

          echo "=== Debug: Token length ==="
          echo "${#FORGE_TOKEN} characters"

          echo "=== Debug: List sites (GET) ==="
          LIST_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $FORGE_TOKEN" \
            -H "Accept: application/json" \
            "https://forge.laravel.com/api/v1/servers/$FORGE_SERVER/sites")
          echo "List sites: HTTP $LIST_STATUS"

          # Find site ID
          SITES_JSON=$(curl -s -H "Authorization: Bearer $FORGE_TOKEN" \
            -H "Accept: application/json" \
            "https://forge.laravel.com/api/v1/servers/$FORGE_SERVER/sites")
          SITE_ID=$(echo "$SITES_JSON" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          for s in data.get('sites', []):
              if '$SITE_DOMAIN' in s.get('name','') or '$SITE_NAME' in s.get('name',''):
                  print(s['id']); break
          else:
              print('')
          ")
          echo "Site ID: $SITE_ID"

          echo "=== Debug: GET env ==="
          GET_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $FORGE_TOKEN" \
            -H "Accept: application/json" \
            "https://forge.laravel.com/api/v1/servers/$FORGE_SERVER/sites/$SITE_ID/env")
          echo "GET /env: HTTP $GET_STATUS"

          echo "=== Debug: PUT env (dry run) ==="
          PUT_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X PUT \
            -H "Authorization: Bearer $FORGE_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d '{"content":"APP_NAME=DebugTest"}' \
            "https://forge.laravel.com/api/v1/servers/$FORGE_SERVER/sites/$SITE_ID/env")
          PUT_STATUS=$(echo "$PUT_RESPONSE" | tail -1)
          PUT_BODY=$(echo "$PUT_RESPONSE" | sed '$d')
          echo "PUT /env: HTTP $PUT_STATUS"
          if [ "$PUT_STATUS" != "200" ]; then
            echo "PUT /env response body: $PUT_BODY"
          fi

      - name: Configure environment on Forge
        env:
          FORGE_TOKEN: ${{ secrets.FORGE_TOKEN }}
          FORGE_SERVER: ${{ secrets.FORGE_SERVER }}
          FORGE_DB_PASSWORD: ${{ secrets.FORGE_DB_PASSWORD }}
          FORGE_STRIPE_KEY: ${{ secrets.FORGE_STRIPE_KEY }}
          FORGE_STRIPE_SECRET: ${{ secrets.FORGE_STRIPE_SECRET }}
          FORGE_STRIPE_WEBHOOK_SECRET: ${{ secrets.FORGE_STRIPE_WEBHOOK_SECRET }}
        run: |
          BRANCH="${{ github.head_ref }}"
          SITE_NAME=$(echo "$BRANCH" | tr -cd '[:alnum:]-')
          SITE_DOMAIN="${SITE_NAME}.preview.intentional.systems"
          echo "Looking up site: $SITE_DOMAIN"

          # Find site ID by domain
          SITES_JSON=$(curl -s -H "Authorization: Bearer $FORGE_TOKEN" \
            -H "Accept: application/json" \
            "https://forge.laravel.com/api/v1/servers/$FORGE_SERVER/sites")
          SITE_ID=$(echo "$SITES_JSON" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          for s in data.get('sites', []):
              if '$SITE_DOMAIN' in s.get('name','') or '$SITE_NAME' in s.get('name',''):
                  print(s['id']); break
          else:
              print('')
          ")
          echo "Site ID: $SITE_ID"

          if [ -z "$SITE_ID" ]; then
            echo "::warning::Could not find site ID â€” Harbor may use a different naming. Skipping env config."
            exit 0
          fi

          # Build .env content
          ENV_CONTENT="APP_NAME=${{ inputs.app-name }}
          APP_ENV=staging
          APP_KEY=
          APP_DEBUG=true
          APP_TIMEZONE=UTC
          APP_URL=https://${SITE_DOMAIN}
          APP_LOCALE=en
          APP_FALLBACK_LOCALE=en
          APP_FAKER_LOCALE=en_US
          APP_MAINTENANCE_DRIVER=file
          BCRYPT_ROUNDS=12
          LOG_CHANNEL=stack
          LOG_STACK=single
          LOG_DEPRECATIONS_CHANNEL=null
          LOG_LEVEL=debug
          DB_CONNECTION=mysql
          DB_HOST=127.0.0.1
          DB_PORT=3306
          DB_DATABASE=${SITE_NAME}
          DB_USERNAME=forge
          DB_PASSWORD=${FORGE_DB_PASSWORD}
          SESSION_DRIVER=database
          SESSION_LIFETIME=120
          SESSION_ENCRYPT=false
          SESSION_PATH=/
          SESSION_DOMAIN=null
          BROADCAST_CONNECTION=log
          FILESYSTEM_DISK=local
          QUEUE_CONNECTION=database
          CACHE_STORE=database
          CACHE_PREFIX=
          MAIL_MAILER=log
          VITE_APP_NAME=${{ inputs.app-name }}"

          # Append extra env
          EXTRA_ENV="${{ inputs.extra-env }}"
          if [ -n "$EXTRA_ENV" ]; then
            ENV_CONTENT="${ENV_CONTENT}
          ${EXTRA_ENV}"
          fi

          # Append Stripe if provided
          if [ -n "${FORGE_STRIPE_KEY:-}" ]; then
            ENV_CONTENT="${ENV_CONTENT}
          STRIPE_KEY=${FORGE_STRIPE_KEY}
          STRIPE_SECRET=${FORGE_STRIPE_SECRET}
          STRIPE_WEBHOOK_SECRET=${FORGE_STRIPE_WEBHOOK_SECRET}"
          fi

          # Write env content to temp file for safe JSON encoding
          echo "$ENV_CONTENT" > /tmp/env_content.txt

          # Update env on Forge via API using curl + jq for safe JSON encoding
          ENV_JSON=$(python3 -c "
          import json, sys
          with open('/tmp/env_content.txt') as f:
              content = f.read().strip()
          print(json.dumps({'content': content}))
          ")

          ENV_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X PUT \
            -H "Authorization: Bearer $FORGE_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d "$ENV_JSON" \
            "https://forge.laravel.com/api/v1/servers/$FORGE_SERVER/sites/$SITE_ID/env")
          ENV_STATUS=$(echo "$ENV_RESPONSE" | tail -1)
          ENV_BODY=$(echo "$ENV_RESPONSE" | sed '$d')

          if [ "$ENV_STATUS" != "200" ]; then
            echo "::error::Failed to update env: HTTP $ENV_STATUS"
            echo "Response: $ENV_BODY"
            exit 1
          fi
          echo "Env updated: HTTP $ENV_STATUS"

          # Trigger deploy
          DEPLOY_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $FORGE_TOKEN" \
            -H "Accept: application/json" \
            "https://forge.laravel.com/api/v1/servers/$FORGE_SERVER/sites/$SITE_ID/deployment/deploy")
          DEPLOY_STATUS=$(echo "$DEPLOY_RESPONSE" | tail -1)
          echo "Deploy triggered: HTTP $DEPLOY_STATUS"

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ github.head_ref }}';
            const siteName = branch.replace(/[^a-zA-Z0-9-]/g, '');
            const previewUrl = `https://${siteName}.preview.intentional.systems`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ **Preview deployed!**\n\nðŸ“± **Preview URL:** ${previewUrl}\n\n_This preview will be automatically torn down when the PR is closed._`
            });
